var W=Object.defineProperty;var j=Object.getOwnPropertySymbols;var X=Object.prototype.hasOwnProperty,Z=Object.prototype.propertyIsEnumerable;var M=(a,n,t)=>n in a?W(a,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[n]=t,A=(a,n)=>{for(var t in n||(n={}))X.call(n,t)&&M(a,t,n[t]);if(j)for(var t of j(n))Z.call(n,t)&&M(a,t,n[t]);return a};var O=(a,n,t)=>(M(a,typeof n!="symbol"?n+"":n,t),t);import{r as T,a as b,i as ee,d as L,u as te,l as h,c as V,b as c,o as oe,e as q,f as I,g as H,h as f,N as x,w as N,j as J,k as S,t as Y,F as K,m as ne,n as P,p as z,q as se,s as ae}from"./vendor.6bff6d0b.js";const re=function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))_(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const e of r.addedNodes)e.tagName==="LINK"&&e.rel==="modulepreload"&&_(e)}).observe(document,{childList:!0,subtree:!0});function t(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerpolicy&&(r.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?r.credentials="include":i.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function _(i){if(i.ep)return;i.ep=!0;const r=t(i);fetch(i.href,r)}};re();function $(a){const n=T({value:a,onChange:t=>{n.value=t}});return n}function ce(a){return`${a.getFullYear()}/${a.getMonth()+1}/${a.getDate()} ${a.getHours()}:${a.getMinutes()}:${a.getSeconds()}`}class le{constructor(n,t){O(this,"socket");O(this,"room");this.socket=n,this.room=t}}const y=new Map,G=()=>{b(!1);let a="",n="",t=null;const _=(d,k)=>{if(n=d,a=k,y.has(`${a}@${d}`))return{o:!0,s:y.get(`${a}@${d}`)};const m=new le(ee(d,{transports:["websocket"]}),k);return y.set(`${a}@${d}`,m),{o:!1,s:m}};let i=null,r=null,e=null;return{getInstance:(d,k)=>{const m=_(d,k);return t=m.s,m.o?m.s:(t.socket.on("connect_error",v=>{console.error(v)}),t.socket.on("connect",function(){console.log(`\u94FE\u63A5\u6210\u529F ${t.socket.id}`)}),t.socket.on("control",v=>{v.room===a&&(r==null||r(v))}),t.socket.on("message",v=>{v.room===a&&(i==null||i(v))}),t.socket.on("disconnect",()=>{e==null||e()}),t)},current:()=>t,dispose:()=>{y.forEach(d=>d.socket.disconnect()),y.clear()},onMessage:d=>{i=d},onControl:d=>{r=d},onDisconnect:d=>{e=d},release:()=>{t==null||t.socket.disconnect(),y.delete(`${a}@${n}`)}}},ue=P("\u8FDE\u63A5"),ie=P("\u65AD\u5F00"),de=S("p",null,"\u6D88\u606F:",-1),me=S("p",null,"\u8F93\u5165:",-1),pe=P("\u53D1\u9001"),ve=L({setup(a){const n=te(),t=h.createInstance({name:"rooms"}),_=h.createInstance({name:"users"}),i=h.createInstance({name:"messages"}),r=G(),e=T({id:"",name:""}),o=T({id:"",name:"",host:"",secret:""}),w=b([]),p=b(!1),U=b(0);r.onDisconnect(()=>{console.log("\u79BB\u7EBF"),p.value=!1,setTimeout(()=>{var l,s;(l=r.current())==null||l.socket.emit("control",{action:"connect",id:e.id,name:e.name,room:o.id}),(s=r.current())==null||s.socket.emit("control",{action:"enter_room",room:o.id,id:e.id})},1e3)}),r.onMessage(async l=>{switch(l.type){case"text":{const s=l,u=V.exports.AES.decrypt(s.data.text,o.secret).toString(V.exports.enc.Utf8);let g=null;try{g=JSON.parse(u),g.m!=="#thisistext#"&&(g=null)}catch(ge){}if(g===null){n.error("\u89E3\u7801\u5931\u8D25");return}s.data.text=g.t,w.value.push({name:s.name,text:s.data.text,time:new Date(s.time)}),await i.setItem(new Date().getTime().toString(),{room:s.room,text:s.data.text,type:"text",uid:e.id,time:s.time,name:s.name,sender:s.id}),setTimeout(()=>{D.value.scrollTop=D.value.scrollHeight},1)}break}}),r.onControl(async l=>{switch(l.action){case"login_success":n.success("\u767B\u9646\u6210\u529F"),p.value=!0;break;case"enter_room":{const s=l;s.id===e.id?(o.id=s.room,o.name=s.room_name,await t.setItem(s.room+"&&"+e.id,A({uid:e.id},c(o))),await h.setItem("current_roomd",s.room)):w.value.push({name:s.name,text:"\u8FDB\u5165\u623F\u95F4",time:new Date})}break;case"exit_room":{const s=l;s.id===e.id?(o.id="",o.name=""):w.value.push({name:s.name,text:"\u79BB\u5F00\u623F\u95F4",time:new Date})}break;case"resp_online_users":{const s=l;o.id===s.room&&(U.value=s.count)}break}});const D=b(),F=b(""),R=l=>{F.value=l},d=()=>{var l;(l=r.current())==null||l.socket.emit("message",{type:"text",id:e.id,name:e.name,room:o.id,data:{text:V.exports.AES.encrypt(JSON.stringify({t:F.value,m:"#thisistext#"}),o.secret).toString()}}),F.value=""},k=setInterval(()=>{var l;e.id!=""&&o.host!=""&&o.id!=""&&p.value&&((l=r.current())==null||l.socket.emit("control",{room:o.id,action:"ask_online_users"}))},5e3),m=$(o.host),v=$(e.id),C=$(e.name),E=$(o.id),B=$(o.secret);oe(async()=>{const l=await h.getItem("current_uid");if(l){const u=await _.getItem(l);u&&(e.id=u.id,e.name=u.name,m.value=o.host,v.value=e.id,C.value=e.name)}const s=await h.getItem("current_roomd");if(s){const u=await t.getItem(s+"&&"+e.id);u&&(o.id=u.id,o.name=u.name,o.host=u.host,m.value=o.host,E.value=u.id,o.secret=u.secret,B.value=u.secret)}if(e.id!=""&&o.id!=""&&o.host!=""){const u=r.getInstance(m.value,o.id);u.socket.emit("control",{action:"connect",id:e.id,name:e.name}),u.socket.emit("control",{action:"enter_room",room:o.id,id:e.id})}});const Q=async()=>{e.id=v.value,e.name=C.value,o.id=E.value,o.host=m.value,o.secret=B.value,await h.setItem("current_uid",e.id),await _.setItem(e.id,A({},c(e)));const l=r.getInstance(o.host,o.id);l.socket.emit("control",{action:"connect",id:e.id,name:e.name,room:o.id}),l.socket.emit("control",{action:"enter_room",room:o.id,id:e.id})};return q(()=>{r.release(),clearInterval(k)}),(l,s)=>(I(),H(K,null,[f(c(x),{value:c(m).value,"onUpdate:value":c(m).onChange,placeholder:"HOST",disabled:p.value},null,8,["value","onUpdate:value","disabled"]),f(c(x),{value:c(v).value,"onUpdate:value":c(v).onChange,placeholder:"ID",disabled:p.value},null,8,["value","onUpdate:value","disabled"]),f(c(x),{value:c(C).value,"onUpdate:value":c(C).onChange,placeholder:"NAME",disabled:p.value},null,8,["value","onUpdate:value","disabled"]),f(c(x),{value:c(E).value,"onUpdate:value":c(E).onChange,placeholder:"ROOM",disabled:p.value},null,8,["value","onUpdate:value","disabled"]),f(c(x),{value:c(B).value,"onUpdate:value":c(B).onChange,placeholder:"SECRET",disabled:p.value},null,8,["value","onUpdate:value","disabled"]),f(c(J),{onClick:Q,disabled:p.value},{default:N(()=>[ue]),_:1},8,["disabled"]),f(c(J),{onClick:s[0]||(s[0]=()=>c(r).release()),disabled:!p.value},{default:N(()=>[ie]),_:1},8,["disabled"]),de,S("p",null,"Room: "+Y(`${c(o).name===""?"\u672A\u8FDE\u63A5":c(o).name} \u5728\u7EBF\uFF1A${U.value}`),1),S("div",{ref:(u,g)=>{g.scroll=u,D.value=u},style:{height:"200px",overflowY:"scroll"}},[(I(!0),H(K,null,ne(w.value,u=>(I(),H("p",null,Y(`[${c(ce)(u.time)}] [${u.name}]: ${u.text}`),1))),256))],512),me,f(c(x),{value:F.value,"onUpdate:value":R},null,8,["value"]),f(c(J),{onClick:d,disabled:!p.value},{default:N(()=>[pe]),_:1},8,["disabled"])],64))}}),fe=L({setup(a){const n=G();return q(()=>n.dispose()),(t,_)=>(I(),z(ve))}}),_e=L({setup(a){return(n,t)=>(I(),z(c(se),null,{default:N(()=>[f(fe)]),_:1}))}});ae(_e).mount("#app");
